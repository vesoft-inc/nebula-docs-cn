# 部署Raft listener

全文索引的数据是异步写入Elasticsearch集群的。流程是通过Storage服务的 Raft listener（简称listener）这个单独部署的进程，从Storage服务读取数据，然后将它们写入Elasticsearch集群。

## 前提条件

- 已经了解全文索引的[使用限制](../../4.deployment-and-installation/6.deploy-text-based-index/1.text-based-index-restrictions.md)。

- 已经[部署Nebula Graph集群](../deploy-nebula-graph-cluster.md)。

- 完成[部署Elasticsearch集群](./2.deploy-es.md)。

- 准备一台或者多台额外的服务器，来部署Raft listener。

## 注意事项

- 请保证Nebula 各组件（Metad、Storaged、Graphd、listener）有相同的版本。

- 只能为一个图空间“一次性添加所有的 listener 机器”。尝试向已经存在有 listener 的图空间再添加新 listener 会失败。因此，需在一个命令语句里完整地添加全部的 listener。

## 部署流程

### 第一步：准备listener的配置文件

用户必须在各需要部署listener的机器上准备对应的配置文件。文件名称必须为`nebula-storaged-listener.conf`。用户可以参考提供的[模板](https://github.com/vesoft-inc/nebula-storage/blob/master/conf/nebula-storaged-listener.conf.production)。注意去掉文件后缀`.production`。

```bash
########## nebula-storaged-listener ###########
########## basics ##########
# 是否启动守护进程。
--daemonize=true
# 记录进程ID的文件。
--pid_file=pids_listener/nebula-storaged.pid

########## logging ##########
# 存放日志文件的目录。
--log_dir=logs_listener
# 最小日志级别，即不会记录低于这个级别的日志。可选值为0（INFO）、1（WARNING）、2（ERROR）、3（FATAL）。
--minloglevel=0
# 日志详细级别，值越大，日志记录越详细。可选值为0、1、2、3。
--v=0
# 缓冲日志的最大时间，超时后输出到日志文件。0表示实时输出。单位：秒。
--logbufsecs=0
# 是否将标准输出和标准错误重定向到单独的输出文件。
--redirect_stdout=true
# 标准输出日志文件名称。
--stdout_log_file=storaged-stdout.log
# 标准错误日志文件名称。
--stderr_log_file=storaged-stderr.log
# 要复制到标准错误中的最小日志级别（minloglevel）。
--stderrthreshold=2

########## networking ##########
# 全部Meta服务的IP地址和端口。多个Meta服务用英文逗号（,）分隔。
--meta_server_addrs=192.168.2.x:45500
# listener服务的本地IP地址。
--local_ip=192.168.2.x
# listener服务的RPC守护进程监听端口。
--port=44510
# HTTP服务的IP地址。
--ws_ip=192.168.2.x
# HTTP服务的端口。
--ws_http_port=12021
# HTTP2服务的端口。
--ws_h2_port=12031
# Meta服务的心跳间隔。
--heartbeat_interval_secs=10

########## storage ##########
# listener的WAL目录。只允许使用一个目录。
--listener_path=data/listener
# 出于兼容性考虑，可以忽略此参数。填充一个默认值data。
--data_path=data
# 部件管理器类型，可选值为memory和meta。
--part_man_type=memory
# 批处理操作的默认保留字节。
--rocksdb_batch_size=4096
# BlockBasedTable的默认块缓存大小。单位：兆（MB）。
--rocksdb_block_cache=4
# 存储引擎类型，例如rocksdb、memory等。
--engine_type=rocksdb
# 部件类型，例如simple、consensus等。
--part_type=simple
```

!!! Note

    在配置文件中请使用真实的（listener机器）IP地址替换`127.0.0.1`。

### 第二步：启动listener

执行如下命令启动启动listener：

```bash
./bin/nebula-storaged --flagfile <listener_config_path>/nebula-storaged-listener.conf
```

`listener_config_path`是存放 listener 配置文件的路径。

### 第三步：添加 listener 到 Nebula Graph 集群

[用命令行连接到Nebula Graph](../../2.quick-start/3.connect-to-nebula-graph.md)，然后执行[`USE <space>`](../../3.ngql-guide/9.space-statements/2.use-space.md)进入需要创建全文索引的图空间。然后执行如下命令添加 listener：

```ngql
ADD LISTENER ELASTICSEARCH <listener_ip:port> [,<listener_ip:port>, ...]
```

!!! warning

    listener 必须使用真实的IP地址。

    请在一个语句里完整地添加所有 listener。例如：

```ngql
nebula> ADD LISTENER ELASTICSEARCH 192.168.8.5:46780,192.168.8.6:46780;
```

## 查看 listener

执行`SHOW LISTENER`语句可以列出所有的 listener。

### 示例

```ngql
nebula> SHOW LISTENER;
+--------+-----------------+-----------------------+----------+
| PartId | Type            | Host                  | Status   |
+--------+-----------------+-----------------------+----------+
| 1      | "ELASTICSEARCH" | "[192.168.8.5:46780]" | "ONLINE" |
+--------+-----------------+-----------------------+----------+
| 2      | "ELASTICSEARCH" | "[192.168.8.5:46780]" | "ONLINE" |
+--------+-----------------+-----------------------+----------+
| 3      | "ELASTICSEARCH" | "[192.168.8.5:46780]" | "ONLINE" |
+--------+-----------------+-----------------------+----------+
```

## 删除listener

执行`REMOVE LISTENER ELASTICSEARCH`语句可以删除图空间的所有listener。

### 示例

```ngql
nebula> REMOVE LISTENER ELASTICSEARCH;
```

!!! danger

    删除 listerner 后，将不能重新添加 listerner，因此也无法继续向ES集群同步，文本索引数据将不完整。如果确实需要，只能重新创建 space。


## 下一步

部署[全文索引](2.deploy-es.md)和 listener 后，全文索引会在 Elasticsearch 集群中自动创建，用户可以开始进行全文搜索。详情请参见[全文搜索](../../3.ngql-guide/15.full-text-index-statements/1.search-with-text-based-index.md)。
