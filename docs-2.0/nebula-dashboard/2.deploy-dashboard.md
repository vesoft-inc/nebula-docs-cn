# 安装部署Dashboard

安装部署Dashboard涉及5种服务，本文将详细介绍如何安装部署。

## 下载Dashboard

执行如下命令下载压缩包：

```bash
wget https://oss-cdn.nebula-graph.com.cn/nebula-graph-dashboard/nebula-graph-dashboard-beta.tar.gz
```

## 目录结构说明

执行命令`tar -xvf nebula-graph-dashboard-beta.tar.gz`解压缩，目录`nebula-graph-dashboard`内一共有5个子目录，说明如下。

|目录名称|说明|
|:---|:---|
|node-exporter | 收集集群中机器的资源信息，包括CPU、内存、负载、磁盘和流量。|
|nebula-stats-exporter | 收集集群的性能指标，包括服务IP地址、版本和监控指标（例如查询数量、查询延迟、心跳延迟等）。|
|prometheus | 存储监控数据的时间序列数据库。|
|nebula-http-gateway | 为集群服务提供HTTP接口，访问prometheus服务或者执行nGQL语句与Nebula Graph数据库进行交互。|
|nebula-graph-dashboard| 提供Dashboard服务。该目录名称与根目录相同，请注意区分，后文所述`nebula-graph-dashboard`是指子目录。|

5个目录需要按照部署需要，复制到各个机器上，详情请参见下文。

## 部署 Dashboard

1. 部署`node-exporter`服务。

  !!! note

        集群中的每个机器都需要部署`node-exporter`服务。

  在目录`node-exporter`内执行如下命令启动服务：

  ```bash
  $ nohup ./node-exporter --web.listen-address=:9200 &
  ```

  服务启动后，可以在浏览器中输入`<IP>:9200`检查服务是否正常启动。

2. 部署`nebula-stats-exporter`服务。

  !!! note

        只需要在`nebula-graph-dashboard`服务所在机器部署`nebula-stats-exporter`服务。

  1. 在目录`nebula-stats-exporter`内修改文件`config.yaml`，配置所有服务的HTTP端口，示例如下：

    ```bash
    version: v0.0.2
    nebulaItems:
        - instanceName: metad0
          endpointIP: 192.168.xx.1
          endpointPort: 19559
          componentType: metad
        - instanceName: metad1
          endpointIP: 192.168.xx.2
          endpointPort: 19559
          componentType: metad
        - instanceName: metad2
          endpointIP: 192.168.xx.3
          endpointPort: 19559
          componentType: metad
        - instanceName: graphd0
          endpointIP: 192.168.xx.4
          endpointPort: 19669
          componentType: graphd
        - instanceName: storaged0
          endpointIP: 192.168.xx.5
          endpointPort: 19779
          componentType: storaged
        - instanceName: storaged1
          endpointIP: 192.168.xx.6
          endpointPort: 19779
          componentType: storaged
        - instanceName: storaged2
          endpointIP: 192.168.xx.7
          endpointPort: 19779
    ```

  2. 执行如下命令启动服务：

    ```bash
    $ nohup  ./nebula-stats-exporter  --bare-metal --bare-metal-config=./config.yaml &
    ```

  服务启动后，可以在浏览器中输入`<IP>:9100`检查服务是否正常启动。

3. 部署`prometheus`服务。

  !!! note

        只需要在`nebula-graph-dashboard`服务所在机器部署`prometheus`服务。

  1. 在目录`prometheus`内修改文件`prometheus.yaml`，配置`node-exporter`服务和`nebula-stats-exporter`服务的IP地址和端口，示例如下：

    ```bash
    global:
      scrape_interval:     5s
      evaluation_interval: 5s
    scrape_configs:
      - job_name: 'nebula-exporter'
        static_configs:
          - targets: [
              '192.168.xx.100:9100',  # nebula-stats-exporter服务的IP地址和端口。
            ]
      - job_name: 'node-exporter'
        static_configs:
          - targets: [
              '192.168.xx.101:9200'  # node-exporter服务的IP地址和端口。
            ]
    ```

    - scrape_interval：收集监控数据的间隔时间。默认为1分钟。

    - evaluation_interval：告警规则扫描时间间隔。默认为1分钟。

  2. 执行如下命令启动服务：

    ```bash
    $ nohup ./prometheus --config.file=./prometheus.yaml &
    ```

  服务启动后，可以在浏览器中输入`<IP>:9090`检查服务是否正常启动。

4. 部署`nebula-http-gateway`服务。

  !!! note

        只需要在`nebula-graph-dashboard`服务所在机器部署`nebula-http-gateway`服务。

  在目录`nebula-http-gateway`内执行如下命令启动服务：

  ```bash
  $ nohup ./nebula-httpd &
  ```

  服务启动后，可以在浏览器中输入`<IP>:8090`检查服务是否正常启动。

5. 部署`nebula-graph-dashboard`服务。

  1. 在目录`nebula-graph-dashboard/static/`内修改文件`custom.json`，配置Graph服务的IP地址和端口，示例如下：

    ```bash
    {
        "connection": {
            "ip": "192.168.xx.4",
            "port": 9669
        },
        "alias": {
            "ip:port": "instance1"
        },
        "chartBaseLine": {

        }
    }
    ...
    ```

  2. 在目录`nebula-graph-dashboard`内执行如下命令启动服务：

    ```bash
    $ npm run start
    ```

  服务启动后，可以在浏览器中输入`<IP>:7003`检查服务是否正常启动。

## 停止Dashboard

如果需要停止Dashboard，可以使用`kill -9 <pid>`的方式停止，示例如下：

```bash
$ kill -9 $(lsof -t -i :9200) # 停止node-exporter服务
$ kill -9 $(lsof -t -i :9100) # 停止nebula-stats-exporter服务
$ kill -9 $(lsof -t -i :9090) # 停止prometheus服务
$ kill -9 $(lsof -t -i :8090) # 停止nebula-http-gateway服务
$ cd nebula-graph-dashboard
$ npm run stop # 停止nebula-graph-dashboard服务
```